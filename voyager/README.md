# Voyager Docker Services

This directory contains Docker Compose configuration for the Voyager development server.

## Services

### Beszel Hub (Monitoring)
- **Image**: `henrygd/beszel:latest`
- **Port**: 8090 (web interface)
- **Purpose**: Central monitoring hub for all homelab servers
- **Volume**: `./beszel_data` (persistent database)
- **Security**: Hardened with minimal capabilities

### Beszel Agent (Local Monitoring)
- **Image**: `henrygd/beszel-agent:latest`
- **Purpose**: Monitors local Voyager system via Unix socket
- **Connection**: Unix socket (`/beszel_socket/beszel.sock`) - no network exposure
- **Security**: Hardened with SYS_PTRACE and NET_ADMIN capabilities

### Capture (Legacy - Will be replaced by Beszel)
- **Image**: `ghcr.io/bluewave-labs/capture:latest`
- **Port**: 59232
- **Status**: Running in parallel during Beszel migration
- **Removal**: Planned after Beszel is fully validated

## First-Time Deployment

### ⚠️ IMPORTANT: Two-Stage Setup Required

The Beszel agent **cannot connect on first deployment** because credentials are generated by the hub AFTER deployment.

### Step 1: Initial Deployment

```bash
# Via Ansible (recommended)
ansible-playbook playbooks/dev_server_provision/dev_server_provision.yml

# Or manually
cd ~/docker_projects/voyager  # Note: May be ~/code_base/docker_projects/voyager depending on deployment
docker compose up -d
```

**Expected Result:** 
- ✅ Beszel hub starts successfully
- ❌ Beszel agent starts but fails to authenticate (this is normal!)

### Step 2: Get Credentials from Web UI

1. **Access Beszel hub:**
   ```
   http://YOUR_SERVER_IP:8090
   ```

2. **Create admin account** (first-time login prompt)

3. **Add your first system:**
   - Click "Add System" button
   - **System Name**: `voyager` (or your preference)
   - **Host/IP**: `/beszel_socket/beszel.sock` ⚠️ **CRITICAL: Use this exact path**
   - Click "Add"

4. **Copy credentials from dialog:**
   - `TOKEN`: Long alphanumeric string
   - `KEY`: SSH public key format

### Step 3: Configure Agent

#### Option A: Manual Update (Quick)

```bash
# Edit .env file
cd ~/docker_projects/voyager  # Or ~/code_base/docker_projects/voyager
nano .env

# Replace these lines:
BESZEL_AGENT_TOKEN=changeme
BESZEL_AGENT_KEY=changeme

# With your actual values:
BESZEL_AGENT_TOKEN=<paste-token-here>
BESZEL_AGENT_KEY=<paste-key-here>

# Save and restart agent
docker compose restart beszel-agent
```

#### Option B: Ansible Vault (Permanent)

For future deployments to be fully automated:

```bash
# Add credentials to vault
cd ~/code_base/ansible_projects
ansible-vault edit group_vars/all/vault.yml

# Add these variables:
vault_beszel_agent_token: "your-token-here"
vault_beszel_agent_key: "your-key-here"

# Update deploy_docker_env role template (roles/deploy_docker_env/templates/voyager.env.j2)
# Add Beszel variables to template

# Redeploy
ansible-playbook playbooks/deploy_docker_env/deploy_docker_env.yml -l voyager
```

### Step 4: Verify Connection

```bash
# Check agent logs
docker logs beszel-agent

# Should see:
# - "Starting SSH server addr=/beszel_socket/beszel.sock"
# - No more "401 Unauthorized" errors (WebSocket errors are normal)

# Check in web UI
# - System should show green status
# - Metrics should be updating
```

## Ongoing Operations

### View Logs

```bash
# All services
docker compose logs -f

# Specific service
docker compose logs -f beszel-hub
docker compose logs -f beszel-agent
docker compose logs -f capture
```

### Restart Services

```bash
# Restart all
docker compose restart

# Restart specific service
docker compose restart beszel-agent
```

### Update Images

```bash
# Pull latest images
docker compose pull

# Recreate containers with new images
docker compose up -d
```

## Troubleshooting

### Agent shows "401 Unauthorized" errors

**If via WebSocket (expected):**
```
WARN WebSocket connection failed err="unexpected status code: 401"
```
This is **normal** - we're using Unix socket, not WebSocket.

**If via SSH/Socket:**
- Check TOKEN and KEY in .env file are correct
- Verify you used `/beszel_socket/beszel.sock` as Host/IP in web UI
- Restart agent: `docker compose restart beszel-agent`

### Agent not showing in web UI

1. Check agent is running: `docker ps | grep beszel-agent`
2. Check socket exists: `ls -la beszel_socket/beszel.sock`
3. Check agent logs: `docker logs beszel-agent`
4. Verify system was added with Unix socket path in web UI

### "Permission denied" errors

```bash
# Check ownership of directories
ls -la beszel_data beszel_socket beszel_agent_data

# Fix if needed
sudo chown -R $USER:$USER beszel_*
```

### Database errors on hub startup

Usually indicates capability restrictions too strict. Current working config:
```yaml
cap_drop: ALL
cap_add:
  - CHOWN
  - SETGID
  - SETUID
  - DAC_OVERRIDE
  - FOWNER
```

## Security Notes

**Security Hardening Applied:**
- `no-new-privileges:true` on all containers
- `cap_drop: ALL` drops all default capabilities
- Minimal capabilities added (only what's required)

**Hub Capabilities:**
- `CHOWN`, `SETGID`, `SETUID` - File ownership management
- `DAC_OVERRIDE`, `FOWNER` - Database file operations

**Agent Capabilities:**
- `CHOWN`, `SETGID`, `SETUID` - File ownership management
- `DAC_OVERRIDE` - File operations
- `SYS_PTRACE` - Read process information
- `NET_ADMIN` - Read network statistics

**Network Security:**
- Agent uses Unix socket (no network exposure)
- Hub only exposes port 8090 (web UI)
- No port 45876 needed (would be for network agents)

## Resource Usage

Expected resource consumption:
- **Beszel Hub**: ~9-15 MB RAM, <0.1% CPU
- **Beszel Agent**: ~5-10 MB RAM, <0.1% CPU
- **Capture**: ~50-70 MB RAM (legacy, will be removed)

Total: ~70-95 MB RAM for all monitoring services

## Migration from Capture

**Current Status:** Parallel monitoring (both running)

**Timeline:**
1. ✅ Phase 1: Beszel hub and local agent deployed
2. ⏭️ Phase 2: Deploy agents to all servers
3. ⏭️ Phase 3: Validate metrics for 2+ weeks
4. ⏭️ Phase 4: Decommission Capture

**When removing Capture:**
```bash
# Stop and remove
docker compose stop capture
docker compose rm capture

# Remove from docker-compose.yml
# Remove env_file reference in .env
```

## Documentation

- **Beszel Documentation**: https://beszel.dev/
- **GitHub**: https://github.com/henrygd/beszel
- **Deployment Notes**: `~/beszel-deployment-notes.md` (on Voyager)
- **Agent Setup Guide**: `~/beszel-agent-setup-instructions.md` (on Voyager)

## Support

For issues:
1. Check logs: `docker compose logs -f`
2. Verify .env configuration
3. Check Beszel documentation: https://beszel.dev/guide/troubleshooting
4. Review deployment notes

---

**Last Updated**: 2025-12-28
**Maintained By**: Homelab Infrastructure Team

version: '3.8'

services:
  beszel-agent:
    image: henrygd/beszel-agent:latest
    container_name: beszel-agent-unraid
    hostname: unraid
    restart: unless-stopped

    # Use host networking for simplest setup
    network_mode: host

    environment:
      # Port for SSH communication (agent listens, hub connects)
      PORT: 45876

      # SSH public key from Beszel web UI (set in .env file)
      KEY: "${BESZEL_AGENT_KEY}"

    volumes:
      # Beszel agent data storage
      - ./beszel_agent_data:/var/lib/beszel-agent

      # Docker socket (read-only) - monitor Unraid containers
      - /var/run/docker.sock:/var/run/docker.sock:ro

      # Host filesystem (read-only) - monitor system resources
      - /:/host:ro

    # Security hardening
    security_opt:
      - no-new-privileges:true

    cap_drop:
      - ALL

    cap_add:
      - CHOWN          # File ownership changes
      - SETGID         # Group ID changes
      - SETUID         # User ID changes
      - DAC_OVERRIDE   # File permission overrides
      - SYS_PTRACE     # Read process info
      - NET_ADMIN      # Read network stats

    # Resource limits (optional - adjust as needed)
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M

    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
